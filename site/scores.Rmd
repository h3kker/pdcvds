---
title: VDS Scores
author: hekker
output:
    html_document:
        toc: true
        theme: spacelab
date: "`r format(Sys.time())`"
---

```{r setup, include=FALSE}
library(dplyr)
library(jsonlite)
library(lubridate)
library(knitr)
library(ggplot2)
library(DT)
library(tidyr)
theme_set(theme_bw())
source("_funcs.R")

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load}
team <- load_team("../data/team-2023.json")
```

## Rider Scores

```{r current_table}
team$riders %>%
    select(name, country, team, cat, age, price, pdc_teams, previous, score) %>%
    arrange(desc(score), desc(price)) %>%
    datatable(
        options = list(
            pageLength = 25,
            dom = "ft"
        )
    )
```

```{r score_dev, fig.width=14, fig.height=9}
tmp_cumtable <- team$results %>%
    left_join(
        team$riders %>% select(pid, name)
    ) %>%
    group_by(name) %>%
    arrange(date) %>%
    mutate(score = cumsum(points))

tmp_lastscore <- tmp_cumtable %>%
    group_by(name) %>%
    slice_max(n = 1, order_by = date) %>%
    mutate(date = now())

tmp_init <- tmp_cumtable %>%
    group_by(name) %>%
    summarise(
        date = ymd_hms("2023-02-20 00:00:00"),
        score = 0
    )


bind_rows(tmp_init, tmp_cumtable, tmp_lastscore) %>%
    ggplot(aes(x = date, y = score)) +
        geom_step(aes(color = name)) +
        geom_point() +
        geom_label(data = tmp_lastscore,
            aes(x = date, y = score, label = name),
            hjust = "right") +
        theme(legend.position = "none")
```

## Ranking

```{r ranking}
team$standings %>%
    arrange(desc(date)) %>%
    head(1) %>%
    kable()
```

```{r ranking_hist, fig.width=14}
team$standings %>%
    ggplot(aes(x = date, y = position)) +
    geom_step() +
    ylim(813, 0)
```

## Races

```{r race_table}
team$results %>%
    group_by(race) %>%
    summarise(date = min(date), score = sum(points), count = n()) %>%
    arrange(desc(score)) %>%
    kable()
```

```{r race_cumsum, fig.width=14, fig.height=9}
team$results %>%
    group_by(race) %>%
    summarise(date = min(date), score = sum(points), count = n()) %>%
    arrange(date) %>%
    mutate(score = cumsum(score)) %>%
    ggplot(aes(x = date, y = score)) +
        geom_step() +
        geom_point(aes(size = count)) +
        geom_label(aes(label = race), hjust = "right", nudge_x = -10000)
```

## PCS Specialties

```{r specialties}
team$riders %>%
    select(pid, name, price, spec, spec_rate) %>%
    full_join(team$specialties) %>%
    arrange(desc(price)) %>%
    datatable(
        options = list(
            pageLength = 25,
            dom = "ft"
        )
    )
```
